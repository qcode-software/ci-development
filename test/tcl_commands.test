package require tcltest
namespace import ::tcltest::test
namespace import ::tcltest::cleanupTests
namespace import ::tcltest::testConstraint

set files [lsort [glob -nocomplain "~/ci-development/tcl/*.tcl"]]

foreach file $files {
    source $file
}

test tcl_commands-1.0 \
    {Get the Tcl commands from a string.} \
    -body {
        set test {
            proc test_1 {args} {
                # This is a test proc.
                return 1
            }

            set foo "bar"
        }

        set commands [tcl_commands $test]

        set command1 [lindex $commands 0]
        set command2 [lindex $commands 1]

        if { [lindex $command1 0] ne "proc" } {
            error "Expected proc but got [lindex $command1 0]."
        }

        if { [lindex $command1 1] ne "test_1" } {
            error "Expected test_1 but got [lindex $command1 1]."
        }

        if { [llength [lindex $command1 2]] != 1
             || [lindex [lindex $command1 2] 0] ne "args" } {
            error "Expected {args} but got [lindex $command1 2]."
        }

        if { [llength [split [string trim [lindex $command1 3]] "\n"]] != 2 } {
            error "Expected 2 lines in proc test_1 body but got\
                   [string trim [lindex $command1 3]]."
        }

        if { $command2 ne {set foo "bar"} } {
            error "Expected {set foo "bar"} but got $command2."
        }

        return 1
    } \
    -result 1

cleanupTests
